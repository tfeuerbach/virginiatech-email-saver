<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Submission</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Title -->
        <h1>Processing Your Submission...</h1>

        <!-- Animation Section -->
        <div id="animation-container">
            <div id="submit-animation-container">
                <canvas id="storing-animation" class="animation visible"></canvas>
                <canvas id="login-animation" class="animation hidden"></canvas>
                <canvas id="push-animation" class="animation hidden"></canvas>
                <canvas id="success-animation" class="animation hidden"></canvas>
            </div>            
        </div>

        <!-- Status Message -->
        <p id="status-message">Preparing to submit...</p>
    </div>

    <script type="module">
        import { DotLottie } from "https://esm.sh/@lottiefiles/dotlottie-web";

        const email = localStorage.getItem("email");

        const animationSteps = {
            1: "storing-animation",
            2: "login-animation",
            3: "push-animation",
            4: "success-animation",
        };

        const animationUrls = {
            1: "https://lottie.host/8ac3bb2a-cbac-4f01-b1ed-8f9f850500f8/pkUIu7XE1d.json",
            2: "https://lottie.host/431a01f1-1cdd-4a9c-8a6d-bb87f44cdde0/uSDs8Ocycr.lottie",
            3: "https://lottie.host/8a9d29dc-29d9-4640-902d-279f4e6e7065/5EivasZcWd.lottie",
            4: "https://lottie.host/588ea9d1-e0c7-4fca-91e9-360ea89bcc10/AzcUHnoUuK.lottie",
        };

        const initializedAnimations = {};

        function initializeAnimation(canvasId, src) {
            const canvas = document.getElementById(canvasId);
            canvas.width = 300;
            canvas.height = 300;

            try {
                initializedAnimations[canvasId] = new DotLottie({
                    canvas,
                    src,
                    loop: true,
                    autoplay: true,
                });
                console.log(`Initialized animation for ${canvasId}`);
            } catch (error) {
                console.error(`Failed to initialize animation for ${canvasId}:`, error);
            }
        }

        Object.entries(animationUrls).forEach(([step, url]) => {
            initializeAnimation(animationSteps[step], url);
        });

        function updateProgress(step) {
            const stepMessages = {
                1: "Storing your credentials securely...",
                2: "Attempting to log in...",
                3: "Sending a push notification to your device...",
                4: "Login Successful! Redirecting to your dashboard...",
            };
        
            // Hide all animations
            Object.values(animationSteps).forEach((canvasId) => {
                const canvas = document.getElementById(canvasId);
                canvas.classList.add("hidden");
                canvas.classList.remove("visible");
            });
        
            // Show the current animation
            const currentCanvasId = animationSteps[step];
            const currentCanvas = document.getElementById(currentCanvasId);
            if (currentCanvas) {
                currentCanvas.classList.add("visible");
                currentCanvas.classList.remove("hidden");
            }
        
            // Update status message
            const statusMessage = document.getElementById("status-message");
            statusMessage.textContent = stepMessages[step] || "Processing...";
        
            // Redirect on step 4
            if (step === 4) {
                setTimeout(() => {
                    window.location.href = `/dashboard?email=${encodeURIComponent(email)}`;
                }, 2000);
            }
        }        

        function pollProgress() {
            fetch("/get_progress")
                .then((response) => response.json())
                .then((data) => {
                    updateProgress(data.step);
                })
                .catch((error) => {
                    console.error("Error polling progress:", error);
                });
        }

        setInterval(pollProgress, 1000);
    </script>
</body>
</html>
